{% extends 'layout/backend/base.html' %}
{% block title %}Index{% endblock %}
{% block res %}
    {% load static %}
    <!-- Moment.js v2.20.0 -->
    <script type="text/javascript" src="{% static "js/plugins/fullcalendar/moment.min.js" %}"></script>

    <!-- FullCalendar v4.4.2 -->
    <link href="{% static "css/plugins/fullcalendar/4.4.2/core/main.min.css" %}" rel="stylesheet" />
    <link href="{% static "css/plugins/fullcalendar/4.4.2/daygrid/main.min.css" %}" rel="stylesheet" />
    <link href="{% static "css/plugins/fullcalendar/4.4.2/timegrid/main.min.css" %}" rel="stylesheet" />
    <script src="{% static "js/plugins/fullcalendar/4.4.2/core/main.min.js" %}"></script>
    <script src="{% static "js/plugins/fullcalendar/4.4.2/interaction/main.min.js" %}"></script>
    <script src="{% static "js/plugins/fullcalendar/4.4.2/daygrid/main.min.js" %}"></script>
    <script src="{% static "js/plugins/fullcalendar/4.4.2/timegrid/main.min.js" %}"></script>

    <link href="{% static "css/plugins/daterangepicker/daterangepicker.css" %}" rel="stylesheet">
    <script src="{% static "js/plugins/daterangepicker/daterangepicker.js" %}"></script>

    <script type="text/css">

        .custom,
        .custom div,
        .custom span {
         background-color: green;/* background color */
         border-color: green;/* border color */
         color: yellow;/* text color */
        }

    </script>
{% endblock %}

{% block content %}

    <div id="calendar"></div>

    <div id="addEventDlg" style="display:none">
        <div class="col-md-10 order-md-1">
            <form id="eventForm" data-parsley-validate method="post">
                <div class="mb-3">
                    <label for="name">人員</label>
                    <select class="custom-select d-block w-100" id="name" name="name">
                        {% for user in users %}
                        <option value="{{user.username}}">{{user.username}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="eventDate">時間</label>
                    <input type="text" class="form-control" id="eventDate" name="eventDate" maxlength="35" placeholder="起迄時間" required>
                </div>
                <div class="mb-3">
                    <label for="subject">標題<span class="text-muted"></span></label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="" required></input>
                </div>
                <!-- div class="mb-3">
                    <label for="end">結束時間</label>
                    <input type="text" class="form-control" id="end" name="end" maxlength="30" placeholder="" required>
                </div -->
                <input type="button" class="btn btn-success" value="add" onclick="Calendar.addEvent()" />
            </form>
        </div>
    </div>

    <div id="editEventDlg" style="display:none">
        <div class="col-md-10 order-md-1">
            <form id="editEventForm" data-parsley-validate method="post">
                <input type="hidden" id="event_id" name="event_id" value="" />
                <div class="mb-3">
                    <label for="name">人員</label>
                    <select class="custom-select d-block w-100" id="name" name="name">
                        {% for user in users %}
                        <option value="{{user.username}}">{{user.username}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="editEventDate">時間</label>
                    <input type="text" class="form-control" id="editEventDate" name="editEventDate" maxlength="35" placeholder="" required>
                </div>
                <div class="mb-3">
                    <label for="subject">標題<span class="text-muted"></span></label>
                    <input type="text" class="form-control" id="subject" name="subject" placeholder="" required></input>
                </div>
                <input type="button" class="btn btn-danger" value="delete" onclick="Calendar.confirmDelImg()" />
                <input type="button" class="btn btn-success" value="edit" onclick="Calendar.editEvent()" />
            </form>
        </div>
    </div>

{% endblock %}

{% block run %}

<script type="text/javascript">

    var today = new Date();
    var year = today.getFullYear();
    var mon = today.getMonth() + 1;
    var day = today.getDate();
    var startDate = year + "-" + (mon<10 ? "0" + mon : mon) + "-" + (day<10 ? "0" + day : day);

    var calendar = {};

    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: [ 'interaction', 'dayGrid', 'timeGrid' ],
            defaultView: 'dayGridMonth',
            defaultDate: startDate,
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: 'getEvents',

            dayRender: function(info) {
                var td = info.el;
                //$(td).css('cursor', 'pointer');
                //info.el.css('cursor', 'pointer');
            },

            dateClick: function(info) {
                //alert('Clicked on: ' + info.dateStr);
                Calendar.openNewDlg(info.dateStr);
            },

            eventClick: function(info) {
                Calendar.openEditDlg(info.event.id);
            }

        });

        calendar.render();
    });

    $(function(){
        $('#eventDate').daterangepicker(
            {
                "timePicker": true,
                "timePicker24Hour": true,
                "startDate": startDate,
                "endDate": startDate,
                locale: {
                  format: 'YYYY-MM-DD HH:mm'
                }
            },
            function(start, end, label) {
                //console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label + ')');
            }
        );
    });

    var Calendar = {

        init : function(events){},

        openEditDlg: function(id){
            $('#editEventForm').get(0).reset();
            $('#editEventForm').find('input[id=event_id]').val(id);
            $.post('getEvent', {id: id},
                function(data, status){
                    if(data.status == 'success'){
                        $('#editEventForm').find('select[id=name]').val(data.event.owner);
                        $('#editEventForm').find('input[id=subject]').val(data.event.event);
                        $('#editEventForm').find('input[id=editEventDate]').val((data.event.start + ' ~ ' + data.event.end));
                        $('#editEventDate').daterangepicker(
                            {
                                "timePicker": true,
                                "timePicker24Hour": true,
                                "startDate": data.event.start,
                                "endDate": data.event.end,
                                locale: {
                                  format: 'YYYY-MM-DD HH:mm'
                                }
                            },
                            function(start, end, label) {
                                //console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label + ')');
                            }
                        );
                        Dialog.openDialog('editEventDlg', {title:'Alter Event', width:400, height:350});
                    }else{
                        Dialog.warning(data.message);
                    }
                }
            );
        },

        editEvent: function(){
            if($('#editEventForm').parsley().validate()){
                //var d = $('#calendar').fullCalendar('getDate');
                //$('#calencar').fullCalendar( 'gotoDate', d.getFullYear(), d.getMonth(), d.getDate() )
                //alert("The current date of the calendar is " + moment.format());
                var spinner = new jQuerySpinner({parentId:'body', duration: 500});
                spinner.show();
                var event_id = $('#editEventForm').find('input[id=event_id]').val();
                var userName = $('#editEventForm').find('select[id=name]').val();
                var eventDate = $('#editEventForm').find('input[id=editEventDate]').val();
                var subject = $('#editEventForm').find('input[id=subject]').val();
                $.post('alterEvent', {id: event_id, user_name: userName, event_date: eventDate, subject: subject},
                    function(data, status){
                        if(data.status == 'success'){
                            //$('#calendar').fullCalendar('refetchEvents');
                            calendar.refetchEvents();
                            Dialog.close('editEventDlg');
                        }else{
                            Dialog.warning(data.message);
                        }
                        spinner.hide();
                    }
                );
            }
        },

        openNewDlg: function(startDate){
            $('#eventForm').get(0).reset();
            $('#eventForm').find('select[id=name]').val('{{user.username}}');
            $('#eventDate').data('daterangepicker').setStartDate(startDate);
            $('#eventDate').data('daterangepicker').setEndDate(startDate);
            Dialog.openDialog('addEventDlg', {title:'New Event', width:400, height:350});
        },

        addEvent: function(){
            if($('#eventForm').parsley().validate()){
                var spinner = new jQuerySpinner({parentId:'body', duration: 500});
                spinner.show();
                var userName = $('#eventForm').find('select[id=name]').val();
                var eventDate = $('#eventForm').find('input[id=eventDate]').val();
                var subject = $('#eventForm').find('input[id=subject]').val();
                $.post('addEvent', {user_name: userName, event_date: eventDate, subject: subject},
                    function(data, status){
                        if(data.status == 'success'){
                            //$('#calendar').fullCalendar('refetchEvents');
                            calendar.refetchEvents();
                            Dialog.close('addEventDlg');
                        }else{
                            Dialog.warning(data.message);
                        }
                        spinner.hide();
                    }
                );
            }
        },

        confirmDelImg: function(){
            Dialog.confirm('刪除', '刪除後資料無法還原，您確定要刪除嗎？',
                {
                    confirm: {
                        text: '刪除',
                        btnClass: 'btn-danger',
                        action: function (okbtn) {
                            Calendar.delEvent();
                        }
                    }
                }
            );
        },

        delEvent: function(){
            var spinner = new jQuerySpinner({parentId:'body', duration: 500});
            spinner.show();
            var event_id = $('#editEventForm').find('input[id=event_id]').val();
            $.post('delEvent', {id: event_id},
                function(data, status){
                    if(data.status == 'success'){
                        //$('#calendar').fullCalendar('refetchEvents');
                        calendar.refetchEvents();
                        Dialog.close('editEventDlg');
                    }else{
                        Dialog.warning(data.message);
                    }
                    spinner.hide();
                }
            );
        }

    };


</script>
{% endblock %}